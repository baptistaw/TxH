// Schema Prisma - Sistema Registro Anestesiológico TxH
// Migración desde AppSheet + Google Sheets
// Clave primaria clínica: CI (Cédula de Identidad uruguaya)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS - Catálogos de referencia
// ============================================================================

/// Sexo biológico del paciente
enum Sex {
  M // Masculino
  F // Femenino
  O // Otro/No especificado
}

/// Clasificación ASA (American Society of Anesthesiologists)
enum ASA {
  I
  II
  III
  IV
  V
  VI
}

/// Rol del clínico en el equipo quirúrgico
enum Role {
  ANESTESIOLOGO // Anestesiólogo
  CIRUJANO // Cirujano
  INTENSIVISTA // Médico intensivista
  HEPATOLOGO // Hepatólogo
  NURSE_COORD // Enfermera coordinadora
}

/// Especialidad del clínico
enum Specialty {
  ANESTESIOLOGO
  CIRUJANO
  INTENSIVISTA
  HEPATOLOGO
  COORDINADORA
  OTRO
}

/// Rol de usuario en el sistema (permisos)
enum UserRole {
  ADMIN         // Administrador - permisos absolutos
  ANESTESIOLOGO // Puede crear y editar pacientes, trasplantes y procedimientos
  VIEWER        // Solo visualización
}

/// Origen/período de los datos para estudios retrospectivos
/// Permite identificar la calidad y completitud de los datos históricos
enum DataSource {
  EXCEL_PRE_2019 // Datos del registro en Excel (hasta 2019) - datos precarios, campos incompletos
  APPSHEET       // Datos de la plataforma Appsheet (2019-2024) - datos más completos
  PLATFORM       // Datos de esta plataforma (2024+) - datos completos con todos los campos
}

/// Prestador de salud (mutualista/público)
/// Prestadores de salud de Uruguay (IAMC y ASSE)
enum Provider {
  // ASSE (Administración de los Servicios de Salud del Estado)
  ASSE

  // Instituciones de Asistencia Médica Colectiva (IAMC) - Montevideo
  AMECOM        // Asociación Médica de Colón
  AMEDRIN       // Asistencia Médica Integral
  AMSJ          // Asistencia Médica San José
  ASOC_ESPANOLA // Asociación Española
  CAAMEPA       // Cooperativa Asistencial Médica de Pando
  CAMCEL        // Centro de Asistencia Médica de Cerro Largo
  CAMDEL        // Centro de Asistencia del Litoral
  CAMEC         // Centro de Asistencia Médica de Canelones
  CAMEDUR       // Centro de Asistencia Médica de Durazno
  CAMOC         // Centro de Asistencia Médica de Colonia
  CAMS          // Centro de Asistencia Médica de Salto
  CAMY          // Centro de Asistencia Médica de Young
  CASA_GALICIA  // Casa de Galicia
  CASMER        // Casa de Salud Mercedes
  CASMU         // Centro de Asistencia del Sindicato Médico del Uruguay
  CCOU          // Crédito Cooperativo Obreros Unidos
  COMECA        // Corporación Médica de Canelones
  COMEF         // Cooperativa Médica de Florida
  COMEFLO       // Cooperativa Médica de Flores
  COMEPA        // Cooperativa Médica de Paysandú
  COMERI        // Cooperativa Médica de Rivera
  COMERO        // Cooperativa Médica de Rocha
  COMETT        // Cooperativa Médica de Tacuarembó
  COMTA         // Cooperativa Médica de Treinta y Tres
  COSEM         // Cooperativa de Servicios Médicos
  CRAME         // Círculo Médico de Melo
  CRAMI         // Círculo Médico de Minas
  CUDAM         // Corporación Uruguaya de Asistencia Médica
  EVANGELICO    // Hospital Evangélico
  GREMCA        // Gremial Médica de Canelones
  GREMEDA       // Gremial Médica de Artigas
  IAC           // Instituto de Asistencia de Canelones
  MUCAM         // Mutualista Camino
  SMI           // Sociedad Médica Italiana
  SMQS          // Sociedad Médica Quintín Saubidet
  UNIVERSAL     // Médica Uruguaya

  // Seguros Privados
  FEMI          // Federación Médica del Interior
  MP            // Medicina Privada

  // Otros
  OTRA          // Otra institución
}

/// Fase del procedimiento intraoperatorio
enum IntraopPhase {
  ESTADO_BASAL // Estado basal pre-quirúrgico
  INDUCCION // Inducción anestésica
  DISECCION // Disección hepática
  ANHEPATICA // Fase anhepática (sin hígado)
  PRE_REPERFUSION // Pre-reperfusión del injerto
  POST_REPERFUSION // Post-reperfusión inmediata
  VIA_BILIAR // Anastomosis vía biliar
  CIERRE // Cierre de pared
  SALIDA_BQ // Salida de bloque quirúrgico
}

/// Modo de ventilación mecánica
enum VentilationMode {
  ESPONTANEA // Ventilación espontánea
  VC // Volumen controlado
  PC // Presión controlada
  SIMV // Ventilación intermitente sincronizada
  PSV // Presión de soporte
  CPAP // Presión positiva continua
  OTRO
}

/// Grado Cormack-Lehane (dificultad de intubación)
enum AirwayGrade {
  I
  II
  III
  IV
}

/// Clase funcional del paciente (NYHA/capacidad funcional)
enum FunctionalClass {
  I
  II
  III
  IV
  NOT_EVALUABLE  // "No se puede evaluar"
  PENDING        // "Pendiente"
}

/// Tipo de procedimiento no-trasplante
/// Tipo de procedimiento (diagnóstico o terapéutico)
enum ProcedureType {
  // Biopsias hepáticas
  BIOPSIA_HEPATICA_PERCUTANEA     // Biopsia hepática percutánea
  BIOPSIA_HEPATICA_TRANSYUGULAR   // Biopsia hepática transyugular
  BIOPSIA_HEPATICA_PROTOCOLO      // Biopsia de protocolo post-trasplante

  // Endoscopías digestivas
  FGC_DIAGNOSTICA                 // Fibrogastroscopía diagnóstica
  FGC_TERAPEUTICA                 // Fibrogastroscopía terapéutica
  FGC_LIGADURA_VARICES           // Ligadura de várices esofágicas
  FGC_ESCLEROTERAPIA             // Escleroterapia de várices
  FBC_DIAGNOSTICA                // Fibrocolonoscopía diagnóstica
  FBC_BIOPSIA                    // Fibrocolonoscopía con biopsia

  // CPRE y vía biliar
  CPRE_DIAGNOSTICA               // CPRE diagnóstica
  CPRE_ESFINTEROTOMIA           // CPRE con esfinterotomía
  CPRE_PROTESIS_BILIAR          // CPRE con colocación de prótesis biliar
  CPRE_DILATACION_ESTENOSIS     // CPRE con dilatación de estenosis
  COLANGIOGRAFIA_TRANSPARIETOHEPATICA // Colangiografía transparietohepática

  // Procedimientos intervencionistas
  TIPS                           // TIPS (Shunt portosistémico intrahepático transyugular)
  PARACENTESIS_DIAGNOSTICA      // Paracentesis diagnóstica
  PARACENTESIS_EVACUADORA       // Paracentesis evacuadora
  TORACENTESIS                  // Toracentesis
  ARTERIOGRAFIA_HEPATICA        // Arteriografía hepática
  EMBOLIZACION_ARTERIAL         // Embolización arterial
  QUIMIOEMBOLIZACION_TACE       // Quimioembolización transarterial (TACE)
  RADIOFRECUENCIA_HEPATICA      // Ablación por radiofrecuencia hepática

  // Accesos vasculares y diálisis
  COLOCACION_CVC                // Colocación de catéter venoso central
  COLOCACION_CATETER_DIALISIS   // Colocación de catéter de diálisis
  HEMODIALISIS                  // Sesión de hemodiálisis
  DIALISIS_PERITONEAL           // Diálisis peritoneal

  // Cirugías abdominales
  LAPAROTOMIA_EXPLORADORA       // Laparotomía exploradora
  DRENAJE_ABSCESO               // Drenaje de absceso
  HERNIOPLASTIA                 // Reparación de hernia
  COLECISTECTOMIA               // Colecistectomía
  ESPLENECTOMIA                 // Esplenectomía
  NEFRECTOMIA                   // Nefrectomía

  // Cirugías torácicas
  TORACOTOMIA                   // Toracotomía
  VIDEOTORACOSCOPIA             // Videotoracoscopía (VATS)
  DRENAJE_PLEURAL               // Drenaje pleural

  // Procedimientos cardíacos
  CORONARIOGRAFIA               // Coronariografía
  ANGIOPLASTIA                  // Angioplastia coronaria
  ECOCARDIOGRAMA_TE             // Ecocardiograma transesofágico

  // Procedimientos urológicos
  CISTOSCOPIA                   // Cistoscopía
  NEFROSTOMIA_PERCUTANEA       // Nefrostomía percutánea

  // Otros procedimientos quirúrgicos
  TRAQUEOSTOMIA                 // Traqueostomía
  GASTROSTOMIA_PERCUTANEA      // Gastrostomía percutánea (PEG)
  CIRUGIA_ORTOPEDICA           // Cirugía ortopédica
  CIRUGIA_VASCULAR             // Cirugía vascular
  CIRUGIA_NEUROLOGICA          // Cirugía neurológica
  PROCEDIMIENTO_DENTAL         // Procedimiento odontológico

  // Trasplante
  TRASPLANTE_HEPATICO          // Trasplante hepático
  RETRASPLANTE_HEPATICO        // Retrasplante hepático
  TRASPLANTE_RENAL             // Trasplante renal

  // Otros
  CER                          // CER (mantener por compatibilidad)
  OTRO                         // Otro procedimiento
}

/// Estado hemodinámico
enum HemodynamicStatus {
  ESTABLE
  INESTABLE
  CRITICO
}

/// Vía aérea utilizada
enum AirwayManagement {
  VAN  // Vía aérea natural
  IOT  // Intubación orotraqueal
  TQT  // Traqueostomía
  MF   // Máscara facial
  ML   // Máscara laríngea
}

/// Patrón ventilatorio
enum VentilationPattern {
  VAN           // No ventilación
  VESP          // Ventilación espontánea
  ARM           // Asistencia respiratoria mecánica
  MF_ESPONTANEA // Máscara facial espontánea
}

/// Técnica anestésica
enum AnesthesiaTechnique {
  AGB                 // Anestesia general balanceada
  AL_POTENCIADA       // Anestesia local potenciada
  SEDACION_LEVE       // Sedación leve-moderada
  SEDACION_PROFUNDA   // Sedación profunda
  REGIONAL            // Anestesia regional
  COMBINADA           // Anestesia combinada
}

// ============================================================================
// MULTI-TENANCY - Organización
// ============================================================================

/// Organización - tenant del sistema (vinculada a Clerk Organization)
model Organization {
  id        String   @id // Clerk Organization ID (org_xxxxx)
  name      String // Nombre de la organización
  slug      String?  @unique // Slug de Clerk (ej: pnth-uruguay)

  // Configuración
  logoUrl   String? // URL del logo (de Clerk o personalizado)
  timezone  String   @default("America/Montevideo")

  // Estado
  isActive  Boolean  @default(true)

  // Metadatos
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Nota: Las relaciones FK están deshabilitadas temporalmente para permitir
  // migración gradual de datos históricos. Los modelos tienen organizationId
  // como String opcional sin constraint.

  @@index([isActive])
  @@map("organizations")
}

// ============================================================================
// MODELOS PRINCIPALES
// ============================================================================

/// Paciente - datos demográficos y clínicos básicos
model Patient {
  // Clave primaria clínica
  id    String  @id @db.VarChar(20) // CI normalizado con DV (8 dígitos sin guión)
  ciRaw String? @db.VarChar(30) // CI original del Excel (auditoría)

  // Multi-tenancy (opcional para datos históricos pre-migración)
  // Sin FK constraint para permitir migración gradual de datos históricos
  organizationId String?

  // Validación de CI
  ciSuspicious Boolean @default(false) // Marca si el DV no coincide
  ciValidationNote String? @db.Text // Razón de sospecha o corrección aplicada

  // Datos demográficos
  name       String
  fnr        String? // Número de historia clínica
  birthDate  DateTime?
  sex        Sex?
  provider   Provider?
  height     Float? // Talla en cm
  weight     Float? // Peso en kg
  bloodGroup String?   @db.VarChar(50) // A+, B-, O+, AB+, NO clasificada, etc.

  // Clasificación ASA
  asa ASA?

  // Datos administrativos
  admissionDate DateTime? // Fecha de ingreso a lista de espera
  placeOfOrigin String?    @db.VarChar(100) // Lugar de procedencia
  transplanted  Boolean   @default(false)

  // Metadatos
  dataSource   DataSource @default(APPSHEET) // Origen de los datos para estudios retrospectivos
  observations String?    @db.Text
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  deletedAt    DateTime?  // Soft delete - null = activo, fecha = eliminado

  // Relaciones
  cases      TransplantCase[]
  procedures Procedure[]
  preops     PreopEvaluation[]
  mortality  Mortality? // Datos de seguimiento y mortalidad

  @@index([organizationId])
  @@index([name])
  @@index([provider])
  @@index([deletedAt]) // Para queries de soft delete
  @@map("patients")
}

/// Clínico - personal médico del equipo
model Clinician {
  id        Int        @id // CP (Código Personal)
  name      String
  specialty Specialty?
  email     String     @unique
  phone     String?

  // Multi-tenancy (opcional para datos históricos pre-migración)
  // Sin FK constraint para permitir migración gradual de datos históricos
  organizationId String?

  // Autenticación Clerk
  clerkId   String?    @unique // ID de usuario en Clerk

  // Autenticación legacy (deprecado - migrar a Clerk)
  password  String?    // Hash de contraseña (bcrypt) - DEPRECADO

  // Permisos
  userRole  UserRole   @default(VIEWER) // Rol en el sistema
  isActive  Boolean    @default(true) // Usuario activo o inactivo

  // Metadatos
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // Soft delete - null = activo, fecha = eliminado

  // Relaciones
  teamAssignments  TeamAssignment[]
  procedures       Procedure[]
  preopEvaluations PreopEvaluation[]

  @@index([organizationId])
  @@index([specialty])
  @@index([userRole])
  @@index([isActive])
  @@index([clerkId])
  @@index([deletedAt])
  @@map("clinicians")
}

/// Caso de trasplante hepático
/// Representa un procedimiento completo (un paciente puede tener múltiples casos si es retrasplante)
model TransplantCase {
  id String @id @default(cuid())

  // Multi-tenancy (opcional para datos históricos pre-migración)
  // Sin FK constraint para permitir migración gradual de datos históricos
  organizationId String?

  // Relación con paciente
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Fechas del procedimiento
  startAt  DateTime? // Inicio quirófano
  endAt    DateTime? // Fin procedimiento
  duration Int? // Duración en minutos (calculado)

  // Características del caso
  isRetransplant Boolean  @default(false)
  isHepatoRenal  Boolean  @default(false) // Trasplante hepato-renal simultáneo
  optimalDonor   Boolean? // Donante óptimo
  provenance     String? // Procedencia: domicilio, CTI, sala, etc.

  // Tiempos de isquemia (minutos)
  coldIschemiaTime Int? // Tiempo isquemia fría
  warmIschemiaTime Int? // Tiempo isquemia caliente

  // Estado post-procedimiento
  icuTransferDate DateTime?

  // Metadatos
  dataSource   DataSource @default(APPSHEET) // Origen de los datos para estudios retrospectivos
  observations String?    @db.Text
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  deletedAt    DateTime?  // Soft delete - null = activo, fecha = eliminado

  // Relaciones
  team             TeamAssignment[]
  preops           PreopEvaluation[]
  intraopRecords   IntraopRecord[]
  fluidsBlood      FluidsAndBlood[]
  drugs            DrugsGiven[]
  linesMonitoring  LinesAndMonitoring?
  postOp           PostOpOutcome?
  observations_rel Observation[]
  attachments      Attachment[]

  @@index([organizationId])
  @@index([patientId, startAt])
  @@index([startAt])
  @@index([isRetransplant])
  @@index([deletedAt]) // Para queries de soft delete
  @@map("transplant_cases")
}

/// Procedimiento no-trasplante (biopsias, endoscopías, etc.)
model Procedure {
  id String @id @default(cuid())

  // Multi-tenancy (opcional para datos históricos pre-migración)
  // Sin FK constraint para permitir migración gradual de datos históricos
  organizationId String?

  // Relación con paciente
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Fechas del procedimiento
  startAt  DateTime? // Inicio
  endAt    DateTime? // Finalización
  duration Int? // Duración en minutos

  // Tipo de procedimiento
  procedureType       ProcedureType?
  procedureTypeDetail String? // Detalle adicional del tipo

  // Lugar
  location String? // BQ, CTI, Sala, etc.

  // Clasificación
  asa ASA?

  // Estado preoperatorio
  airwayPreop       AirwayManagement?
  ventilationPreop  VentilationPattern?
  hemodynamicsPreop HemodynamicStatus?
  gcs               Int? // Glasgow Coma Scale
  provenance        String? // Procedencia: domicilio, CTI, sala

  // Manejo anestésico
  premedication     Boolean           @default(false)
  prophylacticATB   String? // Antibióticos profilácticos
  airwayIntraop     AirwayManagement?
  fullStomach       Boolean           @default(false) // Estómago ocupado
  rapidSequence     Boolean           @default(false) // Secuencia rápida
  difficultAirway   Boolean           @default(false) // IOT difícil
  position          String? // Posición: DD (decúbito dorsal), DL, etc.
  anesthesiaTech    AnesthesiaTechnique?
  ventilationIntraop VentilationPattern?
  ventModeDetail    String? // Detalle del modo ventilatorio (VCV, PCV, etc.)
  regionalAnesthesia String? // Técnica regional si aplica

  // Estado postoperatorio
  destination       String? // Destino: Sala, CTI, etc.
  airwayPostop      AirwayManagement?
  ventilationPostop VentilationPattern?
  hemodynamicsPostop HemodynamicStatus?

  // Complicaciones
  complications String? @db.Text

  // Observaciones
  observations String? @db.Text

  // ============================================================================
  // INDICADORES DE CALIDAD (KPIs) - Solo aplican a trasplantes
  // ============================================================================

  // Objetivo 1: Protocolo de Reposición de Hemoderivados basado en objetivos
  bloodReplacementProtocol       Boolean?  // Se aplicó el protocolo de reposición?
  bloodReplacementProtocolReason String?   @db.Text // Razón si no se aplicó

  // Objetivo 2: Protocolo de Profilaxis Antibiótica
  antibioticProphylaxisProtocol       Boolean?  // Se aplicó el protocolo de profilaxis ATB?
  antibioticProphylaxisProtocolReason String?   @db.Text // Razón si no se aplicó

  // Objetivo 3: Registro y envío de ficha anestésica
  pdfSentByEmail Boolean   @default(false) // Se envió el PDF por email?
  pdfSentAt      DateTime? // Fecha/hora del envío

  // Objetivo 5: Protocolo Fast Track (Extubación Temprana)
  fastTrackProtocol       Boolean?  // Ingresa a protocolo Fast Track?
  fastTrackProtocolReason String?   @db.Text // Razón si no ingresa

  // Anestesiólogo responsable
  clinicianId Int?
  clinician   Clinician? @relation(fields: [clinicianId], references: [id])

  // Metadatos
  dataSource DataSource @default(APPSHEET) // Origen de los datos para estudios retrospectivos
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  deletedAt  DateTime?  // Soft delete - null = activo, fecha = eliminado

  // Relaciones
  intraopRecordsProcedure ProcedureIntraopRecord[]

  @@index([organizationId])
  @@index([patientId, startAt])
  @@index([startAt])
  @@index([procedureType])
  @@index([clinicianId])
  @@index([deletedAt]) // Para queries de soft delete
  @@map("procedures")
}

/// Registro intraoperatorio para procedimientos NO trasplante
/// Simplificado comparado con IntraopRecord de trasplantes
model ProcedureIntraopRecord {
  id String @id @default(cuid())

  procedureId String
  procedure   Procedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)

  timestamp DateTime

  // Hemodinamia básica
  heartRate Int?
  pas       Int?
  pad       Int?
  pam       Int?
  satO2     Int?
  temp      Float?
  fio2      Float?

  // Ventilación básica (si aplica)
  tidalVolume  Int?
  respRate     Int?
  peep         Int?
  peakPressure Int?

  // Fármacos utilizados (registro simplificado)
  inhalAgent     String?
  opioids        Boolean @default(false)
  hypnotics      Boolean @default(false)
  relaxants      Boolean @default(false)
  vasopressors   Boolean @default(false)
  antibiotics    Boolean @default(false)
  otherDrugs     String? @db.Text

  // Fluidos (simplificado)
  plasmalyte Int @default(0)
  ringer     Int @default(0)
  saline     Int @default(0)

  // Hemoderivados (si se usaron)
  redBloodCells Int @default(0)
  plasma        Int @default(0)

  // Laboratorios intraoperatorios
  // Hematología
  hb        Float? // Hemoglobina g/dL
  hto       Float? // Hematocrito %
  platelets Float? // Plaquetas 10^3/µL

  // Coagulación
  pt         Float? // Tiempo de protrombina seg
  inr        Float? // International Normalized Ratio
  fibrinogen Float? // Fibrinógeno mg/dL

  // Electrolitos
  sodium       Float? // Na+ mEq/L
  potassium    Float? // K+ mEq/L
  ionicCalcium Float? // Ca++ mmol/L

  // Gases arteriales
  pH         Float? // pH arterial
  paO2       Float? // PaO2 mmHg
  paCO2      Float? // PaCO2 mmHg
  hco3       Float? // Bicarbonato mEq/L
  baseExcess Float? // Exceso de base mEq/L
  lactate    Float? // Lactato mmol/L

  // Función renal
  creatinine Float? // Creatinina mg/dL
  glucose    Float? // Glicemia mg/dL

  createdAt DateTime @default(now())

  @@index([procedureId, timestamp])
  @@map("procedure_intraop_records")
}

/// Asignación de equipo quirúrgico por caso
model TeamAssignment {
  id String @id @default(cuid())

  caseId String
  case   TransplantCase @relation(fields: [caseId], references: [id], onDelete: Cascade)

  clinicianId Int
  clinician   Clinician @relation(fields: [clinicianId], references: [id])

  role Role

  createdAt DateTime @default(now())

  @@unique([caseId, clinicianId])
  @@index([caseId])
  @@index([clinicianId])
  @@map("team_assignments")
}

/// Evaluación preoperatoria - scores y comorbilidades
model PreopEvaluation {
  id String @id @default(cuid())

  // Multi-tenancy (opcional para datos históricos pre-migración)
  // Sin FK constraint para permitir migración gradual de datos históricos
  organizationId String?

  // Relaciones
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  caseId String?
  case   TransplantCase? @relation(fields: [caseId], references: [id])

  // Anestesiólogo evaluador
  clinicianId Int?
  clinician   Clinician? @relation(fields: [clinicianId], references: [id])

  evaluationDate DateTime

  // Scores pronósticos
  meld   Int? // Model for End-Stage Liver Disease
  meldNa Int? // MELD-Na (con sodio)
  child  String? @db.VarChar(10) // Child-Pugh: A, B, C

  // Etiología de la hepatopatía
  etiology1   String?
  etiology2   String?
  isFulminant Boolean @default(false)

  // Examen físico
  mpt             String? // Mallampati
  mouthOpening    String?
  physicalExamObs String? @db.Text

  // Comorbilidades cardiovasculares
  coronaryDisease Boolean @default(false)
  hypertension    Boolean @default(false)
  valvulopathy    String? // Tipo de valvulopatía
  arrhythmia      Boolean @default(false)
  dilatedCardio   Boolean @default(false)
  hypertensiveCardio Boolean @default(false) // Cardiopatía hipertensiva

  // Comorbilidades respiratorias
  smokerCOPD Boolean @default(false)
  asthma     Boolean @default(false)

  // Otras comorbilidades
  renalFailure       Boolean @default(false)
  singleKidney       Boolean @default(false)
  diabetes           Boolean @default(false)
  thyroidDysfunction Boolean @default(false)
  previousAbdSurgery Boolean @default(false)
  abdSurgeryDetail   String? @db.Text
  refluxUlcer        Boolean @default(false)
  allergies          String? @db.Text
  pregnancy          Boolean @default(false) // Puerperio/Embarazo
  comorbiditiesObs   String? @db.Text // Observaciones sobre comorbilidades

  // Complicaciones de la cirrosis
  hepatoRenalSyndrome   Boolean @default(false)
  hepatoPulmonarySyndr  Boolean @default(false)
  pulmonaryHypertension Boolean @default(false)
  portalHypertension    Boolean @default(false)
  ascites               Boolean @default(false)
  hydrothorax           Boolean @default(false)
  sbe                   Boolean @default(false) // Peritonitis bacteriana espontánea
  portalThrombosis      Boolean @default(false)
  esophagealVarices     Boolean @default(false)
  encephalopathy        Boolean @default(false)
  hepatocarcinoma       Boolean @default(false)
  bleeding              Boolean @default(false)
  hyponatremia          Boolean @default(false)

  complicationsObs String? @db.Text

  // Estado funcional
  functionalClass FunctionalClass?
  mechanicalVent  Boolean          @default(false)
  habitualMeds    String?          @db.Text

  // Decision de lista
  inList          Boolean @default(false)
  reasonNotInList String? @db.Text
  problems        String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relación con laboratorios
  labs PreopLabs[]

  // Relación con etiologías (normalizada)
  etiologies PreopEtiology[]

  // Archivos adjuntos (estudios de imagen, informes)
  attachments PreopAttachment[]

  @@index([organizationId])
  @@index([patientId])
  @@index([caseId])
  @@index([evaluationDate])
  @@index([clinicianId])
  @@map("preop_evaluations")
}

/// Laboratorios preoperatorios
model PreopLabs {
  id String @id @default(cuid())

  preopId String
  preop   PreopEvaluation @relation(fields: [preopId], references: [id], onDelete: Cascade)

  labDate DateTime

  // Hematología
  hb        Float? // Hemoglobina g/dL
  hto       Float? // Hematocrito %
  platelets Float? // Plaquetas 10^3/µL

  // Coagulación
  pt         Float? // Tiempo de protrombina seg
  inr        Float? // International Normalized Ratio
  fibrinogen Float? // mg/dL

  // Bioquímica
  glucose      Float? // mg/dL
  sodium       Float? // mEq/L
  potassium    Float? // mEq/L
  ionicCalcium Float? // mmol/L
  magnesium    Float? // mEq/L
  azotemia     Float? // mg/dL
  creatinine   Float? // mg/dL
  gfr          Float? // mL/min/1.73m² (Índice filtrado glomerular)

  // Función hepática
  sgot      Float? // TGO/AST U/L
  sgpt      Float? // TGP/ALT U/L
  totalBili Float? // mg/dL
  albumin   Float? // g/dL

  // Otros
  tsh Float? // µUI/mL

  createdAt DateTime @default(now())

  @@index([preopId])
  @@index([labDate])
  @@map("preop_labs")
}

/// Archivos adjuntos de la evaluación preoperatoria (estudios de imagen, informes)
model PreopAttachment {
  id String @id @default(cuid())

  preopId String
  preop   PreopEvaluation @relation(fields: [preopId], references: [id], onDelete: Cascade)

  type String // Tipo de estudio: ECG, Tomografia, PEG, Ecocardiograma, RxTx, InformeLab, etc.

  // Almacenamiento del archivo
  url       String // URL del archivo (local o cloud storage)
  fileName  String // Nombre original del archivo
  mimeType  String? // Tipo MIME (image/jpeg, application/pdf, etc.)
  sizeBytes Int? // Tamaño del archivo en bytes
  fileHash  String? // SHA256 para integridad

  // Metadatos del estudio
  studyDate   DateTime? // Fecha del estudio (puede ser diferente a la evaluación)
  description String?   @db.Text // Descripción o hallazgos del estudio

  // Datos históricos de AppSheet (para migración)
  appsheetUrl String? // URL original de AppSheet/Google Drive

  uploadedAt DateTime @default(now())
  uploadedBy Int? // FK a Clinician que subió el archivo

  createdAt DateTime @default(now())

  @@index([preopId])
  @@index([type])
  @@index([studyDate])
  @@map("preop_attachments")
}

/// Registro intraoperatorio por fase (snapshot de constantes vitales y ventilación)
/// Cada fila representa un punto temporal en una fase específica
model IntraopRecord {
  id String @id @default(cuid())

  caseId String
  case   TransplantCase @relation(fields: [caseId], references: [id], onDelete: Cascade)

  phase     IntraopPhase
  timestamp DateTime // Momento del registro

  // Ventilación
  ventMode        VentilationMode?
  fio2            Float? // Fracción inspirada O2 (0-1, ej: 0.5 = 50%)
  tidalVolume     Int? // mL
  respRate        Int? // rpm
  peep            Int? // cmH2O
  peakPressure    Int? // PVA cmH2O
  plateauPressure Int? // Presión plateau cmH2O
  ieRatio         String? // Relación I:E (ej: "1:2")
  compliance      Float? // Compliance estática (mL/cmH2O)
  minuteVolume    Float? // Volumen minuto (L/min)

  // Agente inhalatorio - parámetros detallados
  inhalAgentFi    Float? // Fracción inspirada del agente (%)
  inhalAgentEt    Float? // Fracción espirada del agente (%)
  inhalAgentMAC   Float? // MAC del agente inhalatorio

  // Hemodinamia
  heartRate Int? // lpm
  satO2     Int? // %
  pas       Int? // mmHg
  pad       Int? // mmHg
  pam       Int? // mmHg (calculado: (PAS + 2*PAD)/3)
  cvp       Int? // PVC cmH2O
  etCO2     Int? // mmHg
  temp      Float? // °C (periférica/superficial)
  tempCentral Float? // °C (central/esofágica/nasofaríngea)

  // Presión arterial pulmonar (Swan-Ganz)
  paps          Int? // mmHg
  papd          Int? // mmHg
  papm          Int? // mmHg
  pcwp          Int? // PCP mmHg (presión capilar pulmonar)
  cardiacOutput Float? // GC L/min

  // Monitoreo avanzado
  bis  Int? // Índice biespectral (0-100)
  emg  Int? // EMG del monitor BIS (dB)
  icp  Int? // Presión intracraneal mmHg
  svO2 Int? // Saturación venosa mixta %
  stSegment  Float? // Segmento ST del ECG (mm)
  rhythmType String? // Tipo de ritmo: "Sinusal", "FA", "Flutter", etc.

  // Laboratorios intraoperatorios
  // Hematología
  hb        Float? // Hemoglobina g/dL
  hto       Float? // Hematocrito %
  platelets Float? // Plaquetas 10^3/µL

  // Coagulación
  pt         Float? // Tiempo de protrombina seg
  inr        Float? // International Normalized Ratio
  fibrinogen Float? // Fibrinógeno mg/dL
  aptt       Float? // Tiempo de tromboplastina parcial activada seg

  // Electrolitos
  sodium       Float? // Na+ mEq/L
  potassium    Float? // K+ mEq/L
  ionicCalcium Float? // Ca++ mmol/L
  magnesium    Float? // Mg mEq/L
  chloride     Float? // Cl- mEq/L
  phosphorus   Float? // P mg/dL

  // Gases arteriales
  pH         Float? // pH arterial
  paO2       Float? // PaO2 mmHg
  paCO2      Float? // PaCO2 mmHg
  sO2Gas     Float? // Saturación O2 de gasometría (%)
  hco3       Float? // Bicarbonato mEq/L
  baseExcess Float? // Exceso de base mEq/L
  anionGap   Float? // Anion gap (mEq/L)
  osmolarity Float? // Osmolaridad calculada (mOsm/kg)
  bilirubinGas Float? // Bilirrubina de gasometría (mg/dL)

  // Gases venosos
  pvpH  Float? // pH venoso
  pvO2  Float? // PvO2 mmHg
  pvCO2 Float? // PvCO2 mmHg

  // Función renal
  azotemia   Float? // BUN/Urea mg/dL
  creatinine Float? // Creatinina mg/dL

  // Función hepática
  sgot       Float? // TGO/AST U/L
  sgpt       Float? // TGP/ALT U/L
  totalBili  Float? // Bilirrubina total mg/dL
  directBili Float? // Bilirrubina directa mg/dL
  albumin    Float? // Albúmina g/dL

  // Metabólicos
  glucose  Float? // Glicemia mg/dL
  lactate  Float? // Lactato mmol/L
  proteins Float? // Proteínas totales g/dL

  // ETE (Ecocardiograma Transesofágico)
  eteRightVentricle  String? // Función VD: "normal", "hipocinética", "severamente disfuncionante"
  eteTapse           String? // TAPSE: "<16mm", "16-20mm", ">20mm"
  eteLeftVentricle   String? // Función VI / FEVI: "conservada", "moderadamente reducida", "severamente reducida"
  eteChamberDilation String? // Dilatación: "AI", "VI", "VD", "AI+VI", "AI+VD", "VI+VD", "AI+VI+VD", "normales"
  etePsap            String? // PSAP: "<40mmHg", "40-60mmHg", ">60mmHg"
  eteThrombus        String? // "No", "Sí"
  etePericardial     String? // "Sin derrame", "Leve", "Moderado", "Severo"
  eteVolumeStatus    String? // Evaluación cualitativa de cavidades: "Hipovolemia grave", "Hipovolemia leve-moderada", "Hipervolemia"
  eteObservations    String? // Observaciones adicionales

  // ROTEM - Parámetros completos para algoritmo de decisión
  rotemCtExtem   Int? // CTEXTEM - Clotting Time del EXTEM (seg)
  rotemCftExtem  Int? // CFTEXTEM - Clot Formation Time del EXTEM (seg)
  rotemA5Extem   Int? // A5EXTEM - Amplitud a los 5 min del EXTEM (mm)
  rotemA10Extem  Int? // A10EXTEM - Amplitud a los 10 min del EXTEM (mm)
  rotemMcfExtem  Int? // MCF EXTEM - Maximum Clot Firmness del EXTEM (mm)
  rotemCli30     Int? // CLI30 - Índice de lisis a los 30 min (%)
  rotemCli60     Int? // CLI60 - Índice de lisis a los 60 min (%)
  rotemMl        Int? // ML - Lisis máxima (%)

  rotemCtFibtem  Int? // CTFIBTEM - Clotting Time del FIBTEM (seg)
  rotemA5Fibtem  Int? // A5FIBTEM - Amplitud a los 5 min del FIBTEM (mm)
  rotemA10Fibtem Int? // A10FIBTEM - Amplitud a los 10 min del FIBTEM (mm)
  rotemMcfFibtem Int? // MCF FIBTEM - Maximum Clot Firmness del FIBTEM (mm)

  rotemCtIntem   Int? // CTINTEM - Clotting Time del INTEM (seg)
  rotemCtHeptem  Int? // CTHEPTEM - Clotting Time del HEPTEM (seg)

  rotemA5Aptem   Int? // A5APTEM - Amplitud a los 5 min del APTEM (mm) - usado en hiperfibrinólisis

  // Fármacos (registro binario - sí/no)
  inhalAgent String? // Agente inhalatorio: "Isoflurano", "Sevoflurano", "Desflurano"

  // Opiáceos
  opioidBolus    Boolean @default(false)
  opioidInfusion Boolean @default(false)

  // Hipnóticos
  hypnoticBolus    Boolean @default(false)
  hypnoticInfusion Boolean @default(false)

  // Relajantes musculares
  relaxantBolus    Boolean @default(false)
  relaxantInfusion Boolean @default(false)

  // Anestésicos locales
  lidocaineBolus    Boolean @default(false)
  lidocaineInfusion Boolean @default(false)

  // Vasopresores e inotrópicos
  adrenalineBolus    Boolean @default(false)
  adrenalineInfusion Boolean @default(false)
  dobutamine         Boolean @default(false)
  dopamine           Boolean @default(false)
  noradrenaline      Boolean @default(false)
  phenylephrine      Boolean @default(false)

  // Otros fármacos
  insulinBolus          Boolean @default(false)
  insulinInfusion       Boolean @default(false)
  furosemide            Boolean @default(false)
  tranexamicBolus       Boolean @default(false)
  tranexamicInfusion    Boolean @default(false)
  calciumGluconBolus    Boolean @default(false)
  calciumGluconInfusion Boolean @default(false)
  sodiumBicarb          Boolean @default(false)
  antibiotics           Boolean @default(false)

  // Marcado de calidad de datos
  suspicious Boolean @default(false) // Marca registros con asignación incierta al caso

  createdAt DateTime @default(now())

  @@index([caseId, phase, timestamp])
  @@index([timestamp])
  @@index([suspicious])
  @@map("intraop_records")
}

/// Fluidos y hemoderivados administrados por fase
model FluidsAndBlood {
  id String @id @default(cuid())

  caseId String
  case   TransplantCase @relation(fields: [caseId], references: [id], onDelete: Cascade)

  phase     IntraopPhase
  timestamp DateTime

  // Reposición de cristaloides (ml)
  plasmalyte Int @default(0)
  ringer     Int @default(0)
  saline     Int @default(0)
  dextrose   Int @default(0)

  // Coloides (ml)
  colloids Int @default(0)
  albumin  Int @default(0)

  // Hemoderivados (unidades o ml)
  redBloodCells Int @default(0) // Unidades
  plasma        Int @default(0) // Unidades
  platelets     Int @default(0) // Concentrados de plaquetas
  cryoprecip    Int @default(0) // ml
  cellSaver     Int @default(0) // ml
  fibrinogen    Int @default(0) // gramos (viales de 1g)
  pcc           Int @default(0) // Concentrado Complejo Protrombínico (unidades)
  factorVII     Int @default(0) // Factor VII (miligramos)

  otherFluids String? @db.Text

  // Pérdidas (ml)
  insensibleLoss Int @default(0)
  ascites        Int @default(0)
  suction        Int @default(0) // Aspirador
  gauze          Int @default(0) // Gasas
  urine          Int @default(0) // Diuresis

  // Balance neto (calculado: reposición - pérdidas)
  balance Int?

  createdAt DateTime @default(now())

  @@index([caseId, phase, timestamp])
  @@map("fluids_and_blood")
}

/// Fármacos administrados durante el procedimiento
model DrugsGiven {
  id String @id @default(cuid())

  caseId String
  case   TransplantCase @relation(fields: [caseId], references: [id], onDelete: Cascade)

  phase     IntraopPhase
  timestamp DateTime

  // Agentes inhalatorios
  inhalAgent String?

  // Opiáceos
  opioidBolus    String? // ej: "Fentanilo 100 mcg"
  opioidInfusion String? // ej: "Remifentanilo 0.1 mcg/kg/min"

  // Hipnóticos
  hypnoticBolus    String? // ej: "Propofol 150 mg"
  hypnoticInfusion String?

  // Relajantes musculares
  relaxantBolus    String? // ej: "Rocuronio 50 mg"
  relaxantInfusion String?

  // Anestésicos locales
  lidocaineBolus    String?
  lidocaineInfusion String?

  // Vasopresores e inotrópicos
  adrenalineBolus    String?
  adrenalineInfusion String?
  dobutamine         String? // mcg/kg/min
  dopamine           String?
  noradrenaline      String?
  phenylephrine      String?

  // Otros fármacos relevantes
  insulinBolus    String?
  insulinInfusion String?
  furosemide      String?
  tranexamic      String? // Ácido tranexámico
  calciumGlucon   String?
  sodiumBicarb    String?
  antibiotics     String?
  otherDrugs      String? @db.Text

  createdAt DateTime @default(now())

  @@index([caseId, phase, timestamp])
  @@map("drugs_given")
}

/// Líneas vasculares y monitoreo instalado
model LinesAndMonitoring {
  id String @id @default(cuid())

  caseId String         @unique
  case   TransplantCase @relation(fields: [caseId], references: [id], onDelete: Cascade)

  // Vías venosas centrales
  cvc1 String? // Ej: "yugular derecha 3 lúmenes"
  cvc2 String?
  cvc3 String?

  // Líneas arteriales
  arterialLine1 String? // Ej: "radial derecha"
  arterialLine2 String?

  // Catéter Swan-Ganz
  swanGanz Boolean @default(false)

  // Vía venosa periférica
  peripheralIV String?

  // Vía aérea
  airwayType   String? // IOT, TQT, otro
  tubeSellick  Boolean      @default(false)
  laryngoscopy AirwayGrade?

  // Tipo de anestesia
  anesthesiaType String? // General, combinada, etc.
  premedication  String?

  // Equipamiento
  warmer          Boolean @default(false) // Calentador (Level1, etc.)
  cellSaverUsed   Boolean @default(false)
  elasticBandages Boolean @default(false)
  pressurePoints  String? @db.Text
  thermalBlanket  Boolean @default(false)

  // Antibióticos profilácticos
  prophylacticATB String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relación con líneas vasculares (normalizada)
  vascularLines VascularLine[]

  @@map("lines_and_monitoring")
}

/// Resultados postoperatorios inmediatos
model PostOpOutcome {
  id String @id @default(cuid())

  caseId String         @unique
  case   TransplantCase @relation(fields: [caseId], references: [id], onDelete: Cascade)

  evaluationDate DateTime

  // Extubación
  extubatedInOR   Boolean @default(false) // Extubado en block quirúrgico
  mechVentHours   Int? // Horas de ARM
  mechVentDays    Int? // Días de ARM
  reintubation24h Boolean @default(false)

  // Reopeación
  reoperation      Boolean @default(false)
  reoperationCause String? @db.Text

  // Complicaciones mayores
  primaryGraftFailure Boolean @default(false)
  acuteRenalFailure   Boolean @default(false)
  pulmonaryEdema      Boolean @default(false)
  neurotoxicity       Boolean @default(false)
  rejection           Boolean @default(false)

  // Scores de gravedad
  apacheInitial Int?

  // Complicaciones específicas
  biliaryComplications  Boolean @default(false)
  vascularComplications Boolean @default(false)
  surgicalBleeding      Boolean @default(false)
  otherComplications    String? @db.Text

  // Estancia
  icuDays       Int?
  wardDays      Int?
  dischargeDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([caseId])
  @@map("postop_outcomes")
}

/// Seguimiento de mortalidad y reingresos
model Mortality {
  id String @id @default(cuid())

  patientId String  @unique
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Mortalidad precoz (<30 días post-Tx)
  earlyDeath Boolean   @default(false)
  deathDate  DateTime?
  deathCause String?   @db.Text

  // Seguimiento
  aliveAtDischarge Boolean  @default(true)
  aliveAt1Year     Boolean?
  aliveAt3Years    Boolean?
  aliveAt5Years    Boolean?

  lateDeathCause String? @db.Text

  // Reingresos
  readmissionWithin6m Boolean @default(false)
  daysToFirstReadm    Int?
  daysToSecondReadm   Int?
  readmissionCause    String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@map("mortality")
}

/// Observaciones clínicas por caso
model Observation {
  id String @id @default(cuid())

  caseId String
  case   TransplantCase @relation(fields: [caseId], references: [id], onDelete: Cascade)

  category  String? // Ej: "Incidente", "Nota anestésica", "Evolución"
  content   String   @db.Text
  authorId  Int? // FK a Clinician (opcional)
  createdAt DateTime @default(now())

  @@index([caseId])
  @@index([createdAt])
  @@map("observations")
}

/// Archivos adjuntos (consentimientos, imágenes, PDFs)
model Attachment {
  id String @id @default(cuid())

  caseId String
  case   TransplantCase @relation(fields: [caseId], references: [id], onDelete: Cascade)

  type      String // Ej: "Consentimiento", "Imagen", "Lab", "Informe"
  url       String // URL de almacenamiento (S3, etc.)
  fileHash  String? // SHA256 para integridad
  fileName  String
  mimeType  String?
  sizeBytes Int?

  uploadedAt DateTime @default(now())
  uploadedBy Int? // FK a Clinician

  @@index([caseId])
  @@map("attachments")
}

// ============================================================================
// AUDITORÍA - Tracking de cambios críticos
// ============================================================================

/// Tipo de acción de auditoría
enum AuditAction {
  CREATE
  UPDATE
  DELETE
  RESTORE      // Restaurar un registro soft-deleted
  SOFT_DELETE  // Soft delete (marcar deletedAt)
}

/// Log de auditoría para cambios críticos
model AuditLog {
  id String @id @default(cuid())

  // Multi-tenancy
  organizationId String?

  // Información del registro afectado
  tableName String   // Nombre de la tabla (patients, transplant_cases, etc.)
  recordId  String   // ID del registro modificado
  action    AuditAction // Tipo de acción

  // Usuario que realizó el cambio
  userId    Int?     // FK a Clinician (opcional para acciones del sistema)
  userEmail String?  // Email del usuario (para auditoría incluso si se borra el usuario)

  // Detalles del cambio
  oldValues Json?    // Valores anteriores (para UPDATE/DELETE)
  newValues Json?    // Valores nuevos (para CREATE/UPDATE)
  changes   Json?    // Resumen de cambios (campos modificados)

  // Metadatos de la request
  ipAddress String?
  userAgent String?
  requestId String?  // ID único de la request para correlacionar múltiples cambios

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([tableName, recordId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// FIRMA DIGITAL DE ACTOS MÉDICOS
// ============================================================================

/// Tipo de documento firmable
enum SignableDocumentType {
  TRANSPLANT_CASE      // Caso de trasplante completo
  PROCEDURE            // Procedimiento no-trasplante
  PREOP_EVALUATION     // Evaluación preoperatoria
}

/// Firma digital de actos médicos
/// Vincula un registro médico con la autenticación del profesional responsable
model DigitalSignature {
  id String @id @default(cuid())

  // Multi-tenancy
  organizationId String?

  // Documento firmado
  documentType SignableDocumentType
  documentId   String // ID del registro firmado (TransplantCase.id, Procedure.id, PreopEvaluation.id)

  // Firmante
  signedById    Int       // FK a Clinician
  signedByEmail String    // Email del firmante (inmutable para auditoría)
  signedByName  String    // Nombre del firmante (inmutable para auditoría)

  // Datos de la firma
  signedAt      DateTime  @default(now())
  signatureHash String    // Hash SHA-256 de: documentId + userId + timestamp + contenido

  // Metadatos de verificación
  ipAddress     String?   // IP desde donde se firmó
  userAgent     String?   // User-Agent del navegador

  // Estado
  isValid       Boolean   @default(true) // false si la firma fue invalidada (ej: documento modificado)
  invalidatedAt DateTime?
  invalidatedReason String?

  // Referencia al audit log
  auditLogId    String?   // ID del registro de auditoría asociado

  @@unique([documentType, documentId]) // Solo una firma válida por documento
  @@index([organizationId])
  @@index([documentType, documentId])
  @@index([signedById])
  @@index([signedAt])
  @@map("digital_signatures")
}

// ============================================================================
// CATÁLOGOS Y TABLAS NORMALIZADAS
// ============================================================================

/// Catálogo de etiologías de hepatopatía
model Etiology {
  id          String  @id @default(cuid())

  // Multi-tenancy (opcional para datos históricos pre-migración)
  // Sin FK constraint para permitir migración gradual de datos históricos
  organizationId String?

  code        String // Código normalizado (ej: "HVC", "NASH", "HAI")
  name        String // Nombre completo
  category    String? // Categoría: viral, autoinmune, metabólica, tóxica, etc.
  description String? @db.Text

  active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  preopEtiologies PreopEtiology[]

  @@unique([organizationId, code]) // Código único por organización
  @@index([organizationId])
  @@index([category])
  @@index([active])
  @@map("etiologies")
}

/// Relación muchos-a-muchos entre evaluaciones preop y etiologías
model PreopEtiology {
  id String @id @default(cuid())

  preopId String
  preop   PreopEvaluation @relation(fields: [preopId], references: [id], onDelete: Cascade)

  etiologyId String
  etiology   Etiology @relation(fields: [etiologyId], references: [id])

  isPrimary Boolean @default(true) // true para etiología primaria, false para secundarias
  order     Int     @default(0) // orden de prioridad (0 = principal)

  createdAt DateTime @default(now())

  @@unique([preopId, etiologyId])
  @@index([preopId])
  @@index([etiologyId])
  @@map("preop_etiologies")
}

/// Tipo de línea vascular
enum LineType {
  CVC        // Catéter venoso central
  ARTERIAL   // Línea arterial
  PERIPHERAL // Vía periférica
}

/// Líneas vasculares instaladas
model VascularLine {
  id String @id @default(cuid())

  linesMonId String
  linesMonitoring LinesAndMonitoring @relation(fields: [linesMonId], references: [id], onDelete: Cascade)

  lineType LineType
  location String // Ej: "yugular derecha", "radial izquierda"
  lumens   Int? // Número de lúmenes (para CVC)
  size     String? // Calibre (ej: "18G", "20G")

  createdAt DateTime @default(now())

  @@index([linesMonId])
  @@index([lineType])
  @@map("vascular_lines")
}

/// Catálogo de procedencias/destinos
model Location {
  id   String @id @default(cuid())

  // Multi-tenancy (opcional para datos históricos pre-migración)
  // Sin FK constraint para permitir migración gradual de datos históricos
  organizationId String?

  code String
  name String

  type String // "provenance" o "destination"

  active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([type])
  @@index([active])
  @@map("locations")
}

/// Catálogo de posiciones quirúrgicas
model Position {
  id   String @id @default(cuid())

  // Multi-tenancy (opcional para datos históricos pre-migración)
  // Sin FK constraint para permitir migración gradual de datos históricos
  organizationId String?

  code String
  name String

  description String? @db.Text

  active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([active])
  @@map("positions")
}

/// Catálogo de antibióticos
model Antibiotic {
  id   String @id @default(cuid())

  // Multi-tenancy (opcional para datos históricos pre-migración)
  // Sin FK constraint para permitir migración gradual de datos históricos
  organizationId String?

  code String
  name String

  category    String? // Categoría: Betalactámico, Aminoglucósido, Fluoroquinolona, etc.
  dosage      String? @db.Text // Dosis y sus indicaciones
  description String? @db.Text

  active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([active])
  @@index([category])
  @@map("antibiotics")
}

/// Catálogo de grupos sanguíneos
model BloodGroup {
  id   String @id @default(cuid())
  code String @unique // A+, A-, B+, B-, AB+, AB-, O+, O-

  createdAt DateTime @default(now())

  @@map("blood_groups")
}

/// Protocolo de antibióticos profilácticos
model AntibioticProtocol {
  id   String @id @default(cuid())

  // Multi-tenancy (opcional para datos históricos pre-migración)
  // Sin FK constraint para permitir migración gradual de datos históricos
  organizationId String?

  name String // Ej: "Profilaxis estándar trasplante hepático"
  code String

  type String // "hepatico", "hepatorrenal", "especial"

  // Condiciones
  isStandard     Boolean @default(false) // Protocolo estándar
  forAllergy     Boolean @default(false) // Para paciente alérgico a betalactámicos
  forColonization String? // "SAMR", "XDR", null

  description String? @db.Text

  active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Fases del protocolo
  phases ProtocolPhase[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([type])
  @@index([active])
  @@index([isStandard])
  @@map("antibiotic_protocols")
}

/// Fase del protocolo antibiótico (pre-incisión, intraop, postop)
model ProtocolPhase {
  id String @id @default(cuid())

  protocolId String
  protocol   AntibioticProtocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)

  phase String // "pre_incision", "intraoperatorio", "postoperatorio"
  order Int    @default(0)

  // Descripción de la fase
  timing      String? // Ej: "30-60min antes de incisión", "durante cirugía"
  duration    String? // Ej: "24 horas", "hasta extubación"
  description String? @db.Text

  // Condiciones especiales
  condition String? // Ej: "Si cirugía >10h", "Si sangrado >1500ml"

  createdAt DateTime @default(now())

  // Antibióticos de esta fase
  antibiotics ProtocolAntibiotic[]

  @@index([protocolId])
  @@map("protocol_phases")
}

/// Antibiótico específico en una fase del protocolo
model ProtocolAntibiotic {
  id String @id @default(cuid())

  phaseId String
  phase   ProtocolPhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  antibioticCode String // Código del antibiótico (PTZ, GENTAMICINA, etc.)
  dose           String // Ej: "4.5 g IV", "5 mg/kg IV"
  frequency      String? // Ej: "c/8h", "dosis única", "BIC"
  route          String  @default("IV") // IV, IM, VO, etc.

  notes String? @db.Text

  order     Int     @default(0)
  createdAt DateTime @default(now())

  @@index([phaseId])
  @@map("protocol_antibiotics")
}

// ============================================================================
// CATÁLOGOS DINÁMICOS GENÉRICOS
// ============================================================================

/// Catálogo genérico (ej: "Sex", "ASA", "Provider", "ProcedureType")
model Catalog {
  id   String @id @default(cuid())

  // Multi-tenancy (opcional para datos históricos pre-migración)
  // Sin FK constraint para permitir migración gradual de datos históricos
  organizationId String?

  name String // Nombre del catálogo (ej: "Sex", "Provider")

  label       String // Etiqueta para mostrar (ej: "Sexo", "Prestador")
  description String? @db.Text

  active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items CatalogItem[]

  @@unique([organizationId, name]) // Nombre único por organización
  @@index([organizationId])
  @@index([active])
  @@map("catalogs")
}

/// Valor de un catálogo (ej: "M" para Sex, "ASSE" para Provider)
model CatalogItem {
  id String @id @default(cuid())

  catalogId String
  catalog   Catalog @relation(fields: [catalogId], references: [id], onDelete: Cascade)

  code  String // Código único dentro del catálogo (ej: "M", "ASSE")
  label String // Etiqueta para mostrar (ej: "Masculino", "ASSE")

  description String? @db.Text
  order       Int     @default(0) // Orden de visualización
  active      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([catalogId, code])
  @@index([catalogId])
  @@index([active])
  @@map("catalog_items")
}
